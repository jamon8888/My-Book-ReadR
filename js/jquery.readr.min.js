// Remixed by @molokoloco 2011 - http://b2bweb.fr
// Src : https://github.com/molokoloco/My-Book-ReadR/

var readr=function(){var O=disqus_url?!0:!1,f=$("#article"),ca=$("#article h1,#article h2,#article h4"),ya=$("#article > p:not(:empty)"),h=$("#aside"),d=$(),F=h.find("ul#summary"),da=$(),ea=h.find("ul#viewport"),G=$(),p=d.find("#help"),H=$("#disqus_thread"),q=$("#resizeHandle"),fb=$("#dragLeft"),za=$("#dragRight"),gb=$("a.top"),p=$("#help"),n=$("#zoomplus"),hb=$("#zoomdefault"),ib=$("#zoomminus"),jb=$("#fullscreen"),kb=$("#autoplay"),fa=$("#helpPanel"),v=$("#minibar"),Aa=v.find("#copier"),lb=v.find("#editer"),
mb=v.find("#noter"),P=$("#notes"),ga=P.find("#notesList"),nb=P.find("#saveNotes");P.find("#formNotes");var w=$(),g=$(window),r=$(document),i=$("body"),ha="html, body",Q=$(),ob=/chrome\//.test(navigator.userAgent.toLowerCase()),o=0,ia="",ja=null,j=null,R=!1,I=!1,ka=function(){"console"in window&&console.log.call(console,arguments)},k=function(a,b,c){$.ajax({url:a,async:b||0,dataType:"script",cache:1,error:function(){alert("Sorry, some JS file not found : "+a)},success:function(){c&&typeof c=="function"&&
c()}})};k("./js/jquery-ui-1.8.14.custom.min.js",0);k("./js/waypoints.min.js",0);k("./js/jquery.mousewheel.min.js",0);$(ha).each(function(){var a=parseInt($(this).scrollTop(),10);g.scrollTop(a+1);if($(this).scrollTop()==a+1)return ha=this.nodeName.toLowerCase(),!1});var Q=$(ha),ma=function(){la.length<1&&window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,b,c){la[b]=c});return la},la={},e=function(){return g.height()},x=function(){return parseInt(Q.scrollTop()||g.scrollTop(),10)},y=function(a){R=
!0;var b=360+Math.abs(a-x())*0.42;b>2222&&(b=0);Q.stop(!0,!1).animate({scrollTop:a},{duration:b,complete:function(){var a=ia;if(a&&(window.location.hash||"")!=a)window.location.hash=a;ia="";R=!1}})},z=function(a){a=parseInt(e()*0.75*a);y(x()+a)};$.fn.extend({scrollToMe:function(a){return this.each(function(){a&&(ia=a);y(parseInt($(this).offset().top,10))})},center:function(){return this.each(function(){var a=$(this),b=(e()-a.outerHeight())/2,c=(g.width()-a.outerWidth())/2;a.css({top:(b>16?b:16)+"px",
left:(c>16?c:16)+"px"})})}});$.waypoints.settings.scrollThrottle=200;$.waypoints.settings.resizeThrottle=200;var na="";ca.each(function(a){na+='<li style="padding-left:'+(parseInt(this.nodeName[1])-1)*3+'px;"><a href="#chapter_'+(a+1)+'" data-id="'+a+'">'+$(this).text()+"</a></li>"}).waypoint({offset:"10%"});$(na).appendTo(F);na=null;da=F.find("a");da.bind("click.readr",function(){setTimeout(function(a){ca.eq(a).trigger("waypoint.reached")},1E3,$(this).data("id"))});ya.waypoint({offset:"35%"});var oa=
function(a){$("#article > p.p-actif").removeClass("p-actif");a.addClass("p-actif").prev("p").addClass("p-actif").end().next("p").addClass("p-actif")};if(O){var pa=null,qa=function(){H.addClass("fade").empty();r.unbind("click.readr",qa);H.unbind("click.readr",notKillDisqus)};notKillDisqus=function(a){a.stopPropagation()};embedDisqus=function(a,b){qa();disqus_identifier=b||"pirate";disqus_url=a||"http://www.b2bweb.fr/bonus/piratons-la-democratie.html";pa&&pa.abort();pa=$.ajax({url:"http://"+disqus_shortname+
"."+disqus_domain+"/embed.js",dataType:"script",async:!1,cache:!1,success:function(){H.removeClass("fade");H.bind("click.readr",notKillDisqus);r.bind("click.readr",qa)}})}}else H.remove();var Ba=function(){ca.each(function(a){$(this).data({id:a}).before('<a name="chapter_'+(a+1)+'" id="chapter_'+(a+1)+'"></a>')});O&&ya.each(function(a){$(this).append('<span class="comment"><a href="'+disqus_url+"?pirate="+a+'#disqus_thread" data-disqus-identifier="pirate='+a+'" id="pirate_'+a+'" title="Commenter le texte (P#'+
a+')">-</a></span>')})};Ba();var Ca=function(a,b){var c=$(this).data("id"),c=da.removeClass("current").eq(b=="up"&&c>1?c-1:c).addClass("current").attr("href");ja&&clearTimeout(ja);R||(ja=setTimeout(function(a){if((window.location.hash||"")!=a)if(a+="_screen",a&&(window.location.hash||"")!=a)window.location.hash=a},400,c))},Da=function(a,b){var c=$(this);j&&clearTimeout(j);j=setTimeout(function(a,b){b==="up"&&(a=a.prev("p"));a.length||a.end();oa(a)},1250,c,b)},Ea=function(){var a=$(this);j&&clearTimeout(j);
j=setTimeout(function(a){oa(a)},1400,a)},Fa=function(){j&&(clearTimeout(j),j=null)},Ga=function(a){a.preventDefault();oa($(this).closest("p"));O&&embedDisqus($(this).attr("href"),$(this).data("disqus-identifier"));return!1},F=h.offset(),S=h.width(),l=h.height(),Ha=function(){S=d.outerWidth();l=d.outerHeight();asideLeft=parseInt(d.css("left"));asideTop=parseInt(d.css("top"));d.css({top:"",left:"",bottom:e()-(asideTop+l)+"px",right:g.width()-(asideLeft+S)+"px"});T()},T=function(){h.height("");S=d.outerWidth();
l=d.outerHeight();asideRight=parseInt(d.css("right"));asideBottom=parseInt(d.css("bottom"));asideRight<16&&(asideRight=16);asideBottom<16&&(asideBottom=16);asideBottom+l+16>e()&&(asideBottom=e()-l-16);l+32>e()&&(l=e()-32-23,h.height(l+"px"),asideBottom=16);d.css({bottom:asideBottom+"px",right:asideRight+"px"})},pb=function(a){a.preventDefault();parseInt(d.height())<=23?(d.height(""),setTimeout(function(){T()},1E3),$(this).removeClass("toggled"),T()):(d.height("23px"),$(this).addClass("toggled"));
return!1};h.removeClass("aside roundered").dialog({dialogClass:"aside",resizable:!1,position:[F.left,F.top-23],scroll:!1,width:S,height:l+23,stack:!1,open:function(){d=h.parent("div.ui-dialog").eq(0).addClass("roundered").css("z-index","250");d.find(".ui-dialog-titlebar-close").replaceWith('<a href="javascript:void(0)" class="ui-dialog-titlebar-toggle" role="button" title="Reduire/Agrandir">Toggle</a>');d.find(".ui-dialog-titlebar-toggle").bind("click.readr",pb);p.detach().appendTo(d.find(".ui-dialog-titlebar"));
h.height("").width("100%");Ha()},dragStop:Ha});var ra=function(){var a=0,a=x(),b=(o-1)*e(),a=a<e()?1:a>=b?o:Math.ceil(o*(a/b));G.removeClass("current").eq(a-1).addClass("current")},Ia=function(a){a.preventDefault();var a=parseInt($(this).text(),10)-1,b=a*e();a==o-1&&(b=(o-1)*e());y(b);return R=!1},Ja=function(){o=Math.ceil(r.height()/e());G.lenght>0&&G.unbind("click.readr",Ia);ea.empty();if(!(o<1)){for(var a=0,b="";a<o;a++)b+='<li><a href="#screen_'+(a+1)+'">'+(a+1)+"</a></li>";$(b).appendTo(ea);
G=ea.find("a");G.bind("click.readr",Ia);ra();T()}};Ja();$('a[href^="#"]').live("click.readr",function(a){if(!a.isDefaultPrevented()){$(this);var b=this.hash,c=$(b);if(c)return a.preventDefault(),c.scrollToMe(b),!1}});var m=62.5,A=null,sa=5;playTimer=150;var J=function(a){m=a<30?30:a;m=m>60&&m<=65?62.5:m;i.css("font-size",a+"%");s("Taille du texte : "+parseInt(a/62.5*100,10)+"%");setTimeout(ta,500)};n.bind("click.readr",function(){J(m+5)});hb.bind("click.readr",function(){J(62.5)});ib.bind("click.readr",
function(){J(m-5)});jb.bind("click.readr",function(){if(!("resizeTo"in window)||!("screen"in window)||!("availHeight"in window.screen)||ob)return alert("Votre navigateur n'autorise pas la page a activer cette fonction...\n\nTouche F11 pour lire confortablement !");window.moveTo(0,0);return window.resizeTo(window.screen.availHeight*0.85,window.screen.availWidth*0.85)});var ua=function(){if(I)K();else{I=!0;var a=playTimer*(10-sa)*3;Ka();A&&clearInterval(A);A=setInterval(Ka,a);s("D&eacute;filement automatique, vitesse : "+
sa+"/10")}},K=function(){I&&(A&&clearInterval(A),A=null,I=!1,s("D&eacute;filement automatique stopp&eacute;"))},Ka=function(){var a=x()+12;a+e()<r.height()?y(a):K()};kb.bind("click.readr",ua);$("<div/>").css({width:"10em",position:"absolute",right:"-10em"}).appendTo(i);$("<div/>").css({width:"100px",position:"absolute",right:"-100px"}).appendTo(i);var t=0.25,B=0,U=0,V=null,W=null,qb=function(){t=0.25;U=B=0;W=V=null},La=function(a,b){a.preventDefault();V&&clearTimeout(V);V=setTimeout(qb,!U||U==b?2400:
0);W||(W=new Date);var c=(new Date).getSeconds()-W.getSeconds();B>10&&c<=3||B>18||t==20?t=20:B>4&&c<=2?t=2:B>2&&(t=1);U=b;B++;b>0?z(-t):z(t);return!1},C=null,X=null,rb=function(){clearInterval(X);X=null;ra();gb.toggleClass("fade",x()<e());d.removeClass("highlight");killMiniBar()},Ma=function(){I||d.addClass("highlight");X||(X=setInterval(ra,150));C&&clearTimeout(C);C=setTimeout(rb,333)},ta=function(){va();Ja();K();fa.center();$.waypoints("refresh")},Na=function(){C&&clearTimeout(C);C=setTimeout(ta,
333)},u=$(),Pa=function(){ka("buildEditable()");f.find("a[name^='chapter_']").remove();f.find("span.comment").remove();var a=f.html(),a=unescape(a+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");u=$('<textarea name="textEdit" id="textEdit" cols="80" rows="100">'+a+"</textarea>").appendTo(i);u.wrap('<form method="post" name="formEdit" id="formEdit" action="actions.php?action=saveText" target="_blank"/>');$("#formEdit").prepend('<button type="submit" id="saveNotes" title="T\u00e9l\u00e9chargez vos notes dans un fichier .txt" accesskey="s 0">Sauver</button>');
u.tinymce({script_url:"./tiny_mce/tiny_mce.js",content_css:"./css/styles_tinymce.css",theme:"advanced",skin:"o2k7",theme_advanced_resizing:!1,width:"80%",height:"90%",plugins:"save,autolink,pagebreak,table,advhr,advimage,advlink,iespell,inlinepopups,preview,searchreplace,print,contextmenu,paste,noneditable,visualchars,nonbreaking",theme_advanced_buttons1:"save,|,newdocument,print,|,undo,redo,|,cut,copy,paste,pastetext,pasteword,|,removeformat,cleanup,|,tablecontrols,|,iespell,visualaid,visualchars,|,search,replace,|,help,|,code",
theme_advanced_buttons2:"formatselect,styleselect,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,link,unlink,|,image,|,bullist,numlist,outdent,indent,blockquote,|,sub,sup,|,pagebreak,hr,charmap,nonbreaking,|,forecolor,backcolor",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom"});setTimeout(function(){$("iframe#textEdit_ifr").css({width:"100%",height:"100%"});
$("form#formEdit").bind("submit",Oa)},900)},Oa=function(a){ka("saveText()");f.html(u.val());return sb(a)},sb=function(a){ka("removeEditable()");a.preventDefault();$("form#formEdit").unbind("submit",Oa);u.animate({opacity:0},600,function(){u.tinymce().destroy();$("form#formEdit").remove();u=$()});Ba();Qa();return!1},Ra={37:"left",39:"right",38:"up",40:"down",13:"enter",17:"ctrl",27:"esc",32:"space",107:"+",109:"-",33:"pageUp",34:"pageDown",96:"0",97:1,98:2,99:3,100:4,101:5,102:6,103:7,104:8,105:9,
48:"0",49:1,50:2,51:3,52:4,53:5,54:6,55:7,56:8,57:9},Sa=function(a){var b=Ra[a.which||a.keyCode]||"",c=!1;switch(b){case "+":J(m+5);c=!0;break;case "-":J(m-5);c=!0;break;case "up":z(-1);c=!0;break;case "down":z(1);c=!0;break;case "left":z(-0.1);c=!0;break;case "right":z(0.1);c=!0;break;case "pageUp":case "pageDown":case "space":case "enter":c=!0;break;default:b&&b>=0&&(c=!0)}if(c)return a.preventDefault(),!1},Ta=function(a){if(!("activeElement"in document&&$(document.activeElement).attr("editable")==
!0)){var b=Ra[a.which||a.keyCode]||"",c=!1;switch(b){case "pageUp":y(0);c=!0;break;case "pageDown":y(r.height());c=!0;break;case "space":case "enter":ua(a);c=!0;break;default:b&&b>=0&&(b<1?K():(sa=b,ua()),c=!0)}if(c)return a.preventDefault(),!1}},wa=$(),xa=$(),Y=0,Z=!1,L=null,Va=function(a){a.preventDefault();var b="";ga.find("div.note").each(function(a){b+="\n---\n"+(a+1)+") "+$(this).text()+"\n"});$("input#saveText").val(b);document.formNotes.submit();Z=!1;g.unbind("unload",Ua);s("Notes sauv&eacute;es");
return!1},Ua=function(a){if(Z&&confirm("Voulez vous telecharger vos notes avant de quitter la page ?"))return Va(a)};addNote=function(){Y++;Z||(Z=!0,g.bind("unload",Ua),P.show());$('<li><a href="#note_'+Y+'">'+M.substr(0,6)+'</a><div class="note roundered" contenteditable="true">'+M+"</div></li>").appendTo(ga);wa.parents("#article").length>0&&wa.addClass("hightlight").prepend('<a name="note_'+Y+'" id="note_'+Y+'"></a>');s("Note ajout&eacute;e")};killNoteTmr=function(){L&&clearTimeout(L);L=null};killNoteOver=
function(){killNoteTmr();xa.fadeOut(300)};ga.delegate("a","mouseenter",function(){killNoteOver();$(this).next("div.note").fadeIn(600)}).delegate("a","mouseleave",function(){xa=$(this).next("div.note");L=setTimeout(killNoteOver,1E3)}).delegate("div.note","mouseenter",function(){killNoteTmr()}).delegate("div.note","mouseleave",function(){xa=$(this);L=setTimeout(killNoteOver,1E3)});nb.bind("click.readr",Va);var Wa=function(){Aa.zclip({path:"./js/ZeroClipboard.swf",copy:M,afterCopy:function(){Aa.zclip("remove");
s("Texte copi&eacute;");killMiniBar()}})};killMiniBar=function(){v.fadeOut(500,function(){$(this).hide();$(this).find("div.zclip").remove()})};delayKillMiniBar=function(){aa=setTimeout(killMiniBar,2600)};protectMiniBar=function(){aa&&clearTimeout(aa);aa=null};getSelectedText=function(a){var b="";if("getSelection"in window)b=window.getSelection();else if("getSelection"in document)b=document.getSelection();else if("selection"in document)b=document.selection.createRange().text;M=$.trim(b)+"";if(M!="")wa=
$(a.target),b=a.pageX,a=a.pageY,protectMiniBar(),v.stop(!0,!1).css({top:parseInt(a,10)+10+"px",left:parseInt(b,10)+5+"px"}).show().fadeIn(500),typeof $().zclip!="function"?k("./js/jquery.zclip.min.js",0,Wa):Wa(),delayKillMiniBar()};v.bind("mouseover.readr",protectMiniBar).bind("mouseleave.readr",delayKillMiniBar).hide();lb.bind("click.readr",function(){f.undelegate("#article h1,#article h2,#article h4","waypoint.reached",Ca).undelegate("#article > p:not(:empty)","waypoint.reached",Da).undelegate("#article > p:not(:empty)",
"mouseenter.readr",Ea).undelegate("#article > p:not(:empty)","mouseleave.readr",Fa).undelegate("span.comment a","click.readr",Ga);g.unbind("scroll.readr",Ma).unbind("resize.readr",Na).unbind("mousewheel.readr",La);r.unbind("keydown.readr",Sa).unbind("keyup.readr",Ta).unbind("mousedown.readr",Xa).unbind("mouseup.readr click.readr",Ya);Za();N="removeEditable";s("&Eacute;diteur HTML");typeof $().tinymce!="function"?k("./tiny_mce/jquery.tinymce.js",0,Pa):Pa();killMiniBar()});mb.bind("click.readr",function(a){addNote(a);
killMiniBar()});var D=null,aa=null,ba=q.width(),E=0,$a=0,M="",bb=function(a){q.css({left:parseInt(a.pageX,10)-ba/2+"px"});D&&clearInterval(D);D=setInterval(ab,500,parseInt(a.pageX,10))},ab=function(a){E=100-(a+ba/2)/g.width()*100;E=E>70?70:E<2?2:E;f.css({marginRight:E+"%"});va();ta()},va=function(){q.css({top:parseInt(f.offset().top,10)+"px",left:parseInt(f.offset().left,10)+f.outerWidth()-ba+"px",height:f.outerHeight()-2+"px"});za.css({width:g.width()-parseInt(q.css("left"),10)-ba+"px"})};va();var cb=
function(a){a=x()+($a-parseInt(a.pageY,10));Q.stop(!0,!1).scrollTop(a)},Xa=function(a){K();var b=$(a.target);if(b.is(q))return a.preventDefault(),q.addClass("actif"),i.bind("mousemove.readr",bb),!1;else if(b.is(fb)||b.is(za)||b.is(f))return a.preventDefault(),$a=parseInt(a.pageY,10),i.bind("mousemove.readr",cb),!1},Ya=function(a){D&&(clearInterval(D),D=null,i.unbind("mousemove.readr",bb),q.removeClass("actif"),ab(parseInt(a.pageX,10)));i.unbind("mousemove.readr",cb);($(a.target).is("#article")||$(a.target).parents("#article").length>
0)&&getSelectedText(a)},n=window.location.hash||"";ma().pirate?$("a#pirate_"+ma().pirate).scrollToMe("#pirate_"+ma().pirate):n&&(n=n.split("_screen"),n.length>0&&$(n[0]).scrollToMe(n[0]));var N="",Za=function(a){w.lenght||(w=$('<div id="overlay" title="Fermer"/>').appendTo(i),w.bind("click.readr",db));w.show().animate({opacity:1},900);a>0&&setTimeout(db,a)},db=function(){N!=""&&(eval(N+"()"),N="");w.animate({opacity:0},900,function(){w.hide()})};p.bind("click.readr",function(a){a.preventDefault();
N="hideHelp";Za();e();fa.outerHeight();fa.css({opacity:0}).show().center().animate({opacity:1},1600);return!1});var eb=5;blinkHelp=function(){p.is(":visible")?p.fadeOut(300):p.fadeIn(300);eb--;eb>=0?setTimeout(blinkHelp,600):p.fadeIn(300)};setTimeout(blinkHelp,600);var s=function(a,b){b=b||4E3;$("div#message").remove();$('<div id="message"/>').html("<p>"+a+"</p>").appendTo(i).animate({top:"-2px"},700).delay(b?b:a.length*80).animate({top:"-20px"},400,function(){$(this).remove()})},Qa=function(){f.delegate("#article h1,#article h2,#article h4",
"waypoint.reached",Ca).delegate("#article > p:not(:empty)","waypoint.reached",Da).delegate("#article > p:not(:empty)","mouseenter.readr",Ea).delegate("#article > p:not(:empty)","mouseleave.readr",Fa).delegate("span.comment a","click.readr",Ga);g.bind("scroll.readr",Ma).bind("resize.readr",Na).bind("mousewheel.readr",La);r.bind("keydown.readr",Sa).bind("keyup.readr",Ta).bind("mousedown.readr",Xa).bind("mouseup.readr click.readr",Ya).focus()};Qa();$(window).bind("load",function(){O&&k("http://"+disqus_shortname+
".disqus.com/count.js",1);k("https://apis.google.com/js/plusone.js",1);k("http://platform.twitter.com/widgets.js",1);$("iframe#facebook").load(function(){k("http://connect.facebook.net/en_US/all.js#appId=235087756512662&amp;xfbml=1",1)}).attr("src","http://www.facebook.com/plugins/like.php?app_id=235087756512662&amp;href&amp;send=false&amp;layout=button_count&amp;width=120&amp;height=20&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font")})};$(document).ready(readr);